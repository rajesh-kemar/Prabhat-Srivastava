<h2 class="page-title">Trip Management</h2>

<div class="top-bar" *ngIf="role === 'Dispatcher'">
  <button class="add-trip-btn" (click)="openTripModal()">âž• Add Trip</button>
</div>

<div *ngIf="filteredTrips.length > 0; else noTrips">
  <table class="trip-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Driver</th>
        <th>Vehicle</th>
        <th>Source</th>
        <th>Destination</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Duration</th>
        <th>Status</th>
        <th *ngIf="role === 'Dispatcher'">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let trip of filteredTrips">
        <td>{{ trip.id }}</td>
        <td>{{ trip.driver?.name || trip.driverId }}</td>
        <td>{{ trip.vehicle?.numberPlate || trip.vehicleId }}</td>
        <td>{{ trip.source }}</td>
        <td>{{ trip.destination }}</td>
        <td>{{ trip.startTime | date: 'dd/MM/yyyy, h:mm a' }}</td>
        <td>{{ trip.endTime ? (trip.endTime | date: 'dd/MM/yyyy, h:mm a') : '-' }}</td>
        <td>{{ trip.durationFormatted }}</td>
        <td>
          <span style="font-weight: 700;" [style.color]="trip.endTime ? 'green' : '#ffd966'">
            {{ trip.endTime ? 'Completed' : 'In Progress' }}
          </span>
        </td>
        <td *ngIf="role === 'Dispatcher'">
          <button class="edit-btn" (click)="editTrip(trip)">Edit</button>
          <button class="delete-btn" (click)="deleteTrip(trip.id)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<ng-template #noTrips>
  <p class="no-data">No trips available</p>
</ng-template>

<!-- Modal for Add/Edit Trip -->
<div class="modal-overlay" *ngIf="showTripModal">
  <div class="modal-content">
    <h2>{{ trip.id ? 'Edit Trip' : 'Add New Trip' }}</h2>
    <form (ngSubmit)="saveTrip()">
      <div class="form-group">
        <label>Driver:</label>
        <select [(ngModel)]="trip.driverId" name="driverId" required>
          <option *ngFor="let driver of drivers" [value]="driver.id">{{ driver.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>Vehicle:</label>
        <select [(ngModel)]="trip.vehicleId" name="vehicleId" required>
          <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">{{ vehicle.numberPlate }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>Start Time:</label>
        <input type="datetime-local" [(ngModel)]="trip.startTime" name="startTime" required />
      </div>

      <div class="form-group" *ngIf="trip.id">
        <label>End Time:</label>
        <input type="datetime-local" [(ngModel)]="trip.endTime" name="endTime" />
      </div>

      <div class="form-group">
        <label>Source:</label>
        <input type="text" [(ngModel)]="trip.source" name="source" required />
      </div>

      <div class="form-group">
        <label>Destination:</label>
        <input type="text" [(ngModel)]="trip.destination" name="destination" required />
      </div>

      <div class="modal-footer">
        <button type="submit" class="save-btn">Save</button>
        <button type="button" (click)="closeTripModal()" class="cancel-btn">Cancel</button>
      </div>
    </form>
  </div>
</div>
